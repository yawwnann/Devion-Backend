generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== USER ====================
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  bio           String?  // User bio/description
  avatar        String?  // Cloudinary URL
  cover         String?  // Profile cover image
  password      String?  // hashed password (null for OAuth users)
  googleId      String?  @unique @map("google_id") // nullable for email/password users
  githubUsername String? @map("github_username")
  githubAccessToken String? @map("github_access_token") // GitHub personal access token for API
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  pages           Page[]
  githubRepos     GitHubRepo[]
  analyticsEvents AnalyticsEvent[]
  projects        Project[]
  categories      ProjectCategory[]
  paymentMethods  PaymentMethod[]
  projectPageSettings ProjectPageSettings?
  todoWeeks       TodoWeek[]
  todoPageSettings TodoPageSettings?
  calendarEvents  CalendarEvent[]

  @@map("users")
}

// ==================== PAGE ====================
model Page {
  id          String   @id @default(uuid())
  title       String   @default("Untitled")
  icon        String?  // emoji or image URL
  cover       String?  // Cloudinary URL
  isArchived  Boolean  @default(false) @map("is_archived")
  isFavorite  Boolean  @default(false) @map("is_favorite")
  
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  parentId    String?  @map("parent_id")
  parent      Page?    @relation("PageToSubpages", fields: [parentId], references: [id], onDelete: Cascade)
  subpages    Page[]   @relation("PageToSubpages")
  
  blocks      Block[]
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([parentId])
  @@map("pages")
}

// ==================== BLOCK ====================
model Block {
  id            String   @id @default(uuid())
  type          String   // text, heading, todo, code, image, embed, chart, etc.
  content       Json     @default("{}") // flexible JSON content
  order         Int      @default(0)    // position within parent
  
  pageId        String   @map("page_id")
  page          Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  parentBlockId String?  @map("parent_block_id")
  parentBlock   Block?   @relation("BlockToChildren", fields: [parentBlockId], references: [id], onDelete: Cascade)
  children      Block[]  @relation("BlockToChildren")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([pageId])
  @@index([parentBlockId])
  @@index([pageId, order])
  @@map("blocks")
}

// ==================== GITHUB ====================
model GitHubRepo {
  id              String   @id @default(uuid())
  repoId          Int      @map("repo_id") // GitHub's repo ID
  name            String
  fullName        String   @map("full_name")
  description     String?
  url             String
  language        String?
  stars           Int      @default(0)
  forks           Int      @default(0)
  openIssues      Int      @default(0) @map("open_issues")
  isPrivate       Boolean  @default(false) @map("is_private")
  
  userId          String   @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  stats           GitHubRepoStat[]
  
  lastSyncedAt    DateTime @map("last_synced_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([userId, repoId])
  @@index([userId])
  @@map("github_repos")
}

model GitHubRepoStat {
  id          String   @id @default(uuid())
  repoId      String   @map("repo_id")
  repo        GitHubRepo @relation(fields: [repoId], references: [id], onDelete: Cascade)
  
  stars       Int      @default(0)
  forks       Int      @default(0)
  commits     Int      @default(0)
  
  recordedAt  DateTime @map("recorded_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([repoId])
  @@index([repoId, recordedAt])
  @@map("github_repo_stats")
}

// ==================== ANALYTICS ====================
model AnalyticsEvent {
  id          String   @id @default(uuid())
  eventType   String   @map("event_type") // page_view, block_created, etc.
  eventData   Json     @default("{}") @map("event_data")
  
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([eventType])
  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@map("analytics_events")
}


// ==================== PROJECT MANAGEMENT ====================
model ProjectCategory {
  id        String    @id @default(uuid())
  name      String
  color     String    @default("gray") // Badge color
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects  Project[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([userId, name])
  @@index([userId])
  @@map("project_categories")
}

model PaymentMethod {
  id        String    @id @default(uuid())
  name      String
  color     String    @default("gray") // Badge color
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects  Project[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([userId, name])
  @@index([userId])
  @@map("payment_methods")
}

model Project {
  id          String           @id @default(uuid())
  name        String
  order       String?          // Client/Order name
  status      String           @default("TODO") // TODO, IN_PROGRESS, DONE
  information String?          // Additional notes
  orderNum    Int              @default(autoincrement()) @map("order_num")
  
  // Dates
  dueDate     DateTime?        @map("due_date")
  startDate   DateTime?        @map("start_date")
  
  // GitHub Integration
  githubRepo  String?          @map("github_repo") // owner/repo format
  githubUrl   String?          @map("github_url")  // Full GitHub URL
  lastSyncedAt DateTime?       @map("last_synced_at")
  
  categoryId  String?          @map("category_id")
  category    ProjectCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  paymentId   String?          @map("payment_id")
  payment     PaymentMethod?   @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  
  userId      String           @map("user_id")
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  calendarEvents CalendarEvent[]
  
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, status])
  @@index([categoryId])
  @@index([paymentId])
  @@map("projects")
}

// Project Page Settings (cover, title, description)
model ProjectPageSettings {
  id          String   @id @default(uuid())
  cover       String?  // Cloudinary URL for cover image
  icon        String?  // Emoji or icon
  title       String   @default("DATA PROJECT")
  description String?
  
  userId      String   @unique @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("project_page_settings")
}

// ==================== TODO LIST ====================
model TodoWeek {
  id        String   @id @default(uuid())
  weekStart DateTime @map("week_start") // Start of the week (Monday)
  weekEnd   DateTime @map("week_end")   // End of the week (Sunday)
  
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  todos     Todo[]
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, weekStart])
  @@index([userId])
  @@map("todo_weeks")
}

model Todo {
  id          String   @id @default(uuid())
  title       String
  isCompleted Boolean  @default(false) @map("is_completed")
  day         String   // Mon, Tue, Wed, Thu, Fri, Sat, Sun
  order       Int      @default(0) // Position within the day
  priority    String   @default("MEDIUM") // HIGH, MEDIUM, LOW
  status      String   @default("TODO") // TODO, SCHEDULED, IN_PROGRESS, DONE
  dueDate     DateTime? @map("due_date") // Optional due date for calendar integration
  
  // GitHub Integration
  githubIssueNumber Int?     @map("github_issue_number")
  githubIssueUrl    String?  @map("github_issue_url")
  githubRepoName    String?  @map("github_repo_name") // owner/repo
  githubLabels      String?  @map("github_labels") // JSON string
  lastSyncedAt      DateTime? @map("last_synced_at")
  
  weekId      String   @map("week_id")
  week        TodoWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)
  
  calendarEvents CalendarEvent[]
  commits        GitHubCommit[]
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([weekId])
  @@index([weekId, day, order])
  @@index([githubIssueNumber, githubRepoName])
  @@map("todos")
}

// GitHub Commit tracking
model GitHubCommit {
  id           String   @id @default(uuid())
  sha          String   @unique // Git commit SHA
  message      String   // Commit message
  author       String   // Author name
  authorEmail  String?  @map("author_email")
  authorAvatar String?  @map("author_avatar") // GitHub avatar URL
  url          String   // GitHub commit URL
  htmlUrl      String   @map("html_url") // Browser URL
  additions    Int      @default(0) // Lines added
  deletions    Int      @default(0) // Lines deleted
  committedAt  DateTime @map("committed_at") // When commit was made
  
  todoId       String   @map("todo_id")
  todo         Todo     @relation(fields: [todoId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([todoId])
  @@index([todoId, committedAt])
  @@map("github_commits")
}

model TodoPageSettings {
  id          String   @id @default(uuid())
  cover       String?  // Cloudinary URL for cover image
  icon        String?  // Emoji or icon
  title       String   @default("Weekly To-do List")
  description String?
  
  userId      String   @unique @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("todo_page_settings")
}

// ==================== CALENDAR ====================
model CalendarEvent {
  id          String   @id @default(uuid())
  title       String
  description String?
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  allDay      Boolean  @default(false) @map("all_day")
  color       String   @default("blue") // Event color
  
  // Event type and source
  eventType   String   @map("event_type") // project, todo, github_issue, custom
  
  // Relations to source entities
  projectId   String?  @map("project_id")
  project     Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  todoId      String?  @map("todo_id")
  todo        Todo?    @relation(fields: [todoId], references: [id], onDelete: Cascade)
  
  // GitHub Issue reference (no direct relation)
  githubIssueNumber Int?    @map("github_issue_number")
  githubRepoName    String? @map("github_repo_name")
  
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, startDate])
  @@index([projectId])
  @@index([todoId])
  @@index([eventType])
  @@map("calendar_events")
}
